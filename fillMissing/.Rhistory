library(plyr)
library(ggplot2)
library(descr)
library(tseries)
library(gridExtra)
library(reshape2)
library(MARSS)
#clear workspace ==============================================================
rm(list = ls())
RDDATA = read.csv("C:/Users/Katharina/Documents/Umich/rdspend/RDDATA.csv")
#libraries ====================================================================
library(plyr)
library(ggplot2)
library(descr)
library(tseries)
library(gridExtra)
library(reshape2)
library(MARSS)
library(KFAS)
library(car)
library(mlogit)
library(nnet)
library(MASS)
#clear workspace ===================================================================
rm(list = ls())
#load RD input data==============================================================
load(file = "inputs.RData")
costrict.dat = read.csv("companiesstrict.csv")
success.dat = read.csv("companiesstictsuccess.csv") #successfully run co's in strict case
successList =levels(as.factor(success.dat$companyName))
companies.dat = costrict.dat[costrict.dat$companyName %in% successList,]
companies.dat$strictFlag = 1
cononstrict.dat = read.csv("companiesnonstrict.csv")
success.dat = read.csv("companiesnonstrictsuccess.csv")
successList = levels(as.factor(success.dat$companyName))
temp = cononstrict.dat[cononstrict.dat$companyName %in% successList,]
temp$strictFlag = 0
companies.dat = rbind(companies.dat, temp)
indstrict.dat = read.csv("industriesstrict.csv")
success.dat = read.csv("industriesstrictsuccess.csv")
successList = levels(as.factor(success.dat$industryName))
industries.dat = indstrict.dat[indstrict.dat$industryName %in% successList,]
industries.dat$strictFlag = 1
indnonstrict.dat = read.csv("industriesnonstrict.csv")
success.dat = read.csv("industriesnonstrictsuccess.csv")
successList = levels(as.factor(success.dat$industryName))
temp= indnonstrict.dat[indnonstrict.dat$industryName %in% successList,]
temp$strictFlag = 0
industries.dat = rbind(industries.dat, temp)
industries.dat
length(levels(factor(industry.dat$industryName)))
industries.dat
length(levels(factor(industries.dat$industryName)))
load("workCosonlynotstrict.RData")
industries.dat$onlyWorkingFlag = 0
missindstrict.dat = read.csv("missingindustriesstrict.csv")
keepInds = c(800,1400,1540,2090,2092,2300,2340,2451,2452,2611,2621,2840,2844,2870,2911,3089,3250,3270,3317,3360,3420,3430,3442,3444,3452,3550,3569,3571,3590,3630,3728,3812,3824,3844) #industries that run with strict restricition if only working companies are used
missindstrict.dat = missindstrict.dat[missindstrict.dat$industryName %in% keepInds,]
missindstrict.dat$strictFlag = 1
missindstrict.dat$onlyWorkingFlag = 1
industries.dat = rbind(industries.dat, missindstrict.dat)
missindnonstrict.dat = read.csv("missingindustriesnonstrict.csv")
keepInds = c(2430, 3433)
missindnonstrict.dat = missindnonstrict.dat[missindnonstrict.dat$industryName %in% keepInds,]
missindnonstrict.dat$strictFlag = 0
missindnonstrict.dat$onlyWorkingFlag = 1
industries.dat = rbind(industries.dat, missindnonstrict.dat)
length(levels(factor(industries.dat$industryName)))
length(levels(factor(companies.dat$companyName)))
lhs.dat = read.csv("lhsdat.csv")
#aggregate dataset
companies.dat$id = paste(companies.dat$industryName, companies.dat$datayear, sep = "")
industries.dat$id = paste(industries.dat$industryName, industries.dat$datayear, sep = "")
reg.dat = merge(x = companies.dat, y = industries.dat, by = "id", all.x = TRUE)
head(reg.dat)
colnames(reg.dat) = c("id", "industryName", "companyName", "datayear", "state_co", "stError_co", "strictFlag_co", "drop", "drop2", "state_ind", "stError_ind", "strictFlag_ind", "onlyWorkingFlag")
reg.dat= reg.dat[,c(1:7, 10:13)]
head(reg.dat)
reg.dat = merge(x = reg.dat, y = lhs.dat, by = "companyName", all.x = TRUE)
head(reg.dat)
lhs.dat$id = paste(lhs.dat$companyName, lhs.dat$dataYear, sep = "")
reg.dat$id = paste(reg.dat$companyName, reg.dat$dataYear, sep = "")
lhs.dat = read.csv("lhsdat.csv")
#aggregate dataset
companies.dat$id = paste(companies.dat$industryName, companies.dat$datayear, sep = "")
industries.dat$id = paste(industries.dat$industryName, industries.dat$datayear, sep = "")
reg.dat = merge(x = companies.dat, y = industries.dat, by = "id", all.x = TRUE)
colnames(reg.dat) = c("id", "industryName", "companyName", "datayear", "state_co", "stError_co", "strictFlag_co", "drop", "drop2", "state_ind", "stError_ind", "strictFlag_ind", "onlyWorkingFlag")
reg.dat= reg.dat[,c(1:7, 10:13)]
lhs.dat$id = paste(lhs.dat$companyName, lhs.dat$dataYear, sep = "")
reg.dat$id = paste(reg.dat$companyName, reg.dat$dataYear, sep = "")
reg.dat = merge(x = reg.dat, y = lhs.dat, by = "id", all.x = TRUE)
head(reg.dat)
reg.dat= reg.dat[,c(1:11,14)]
colnames(reg.dat) = c("id", "industryName", "companyName", "datayear", "state_co", "stError_co", "strictFlag_co", "state_ind", "stError_ind", "strictFlag_ind", "onlyWorkingFlag", "npatappAdj")
head(reg.dat)
length(levels(factor(reg.dat$industryName)))
length(levels(factor(reg.dat$companyName)))
test = reg.dat[is.na(reg.dat$industryName),]
dim(test)
levels(factor(reg.dat$industryName))
test = reg.dat[is.na(reg.dat$state_ind),]
dim(test)
length(levels(factor(reg.dat$companyName)))
length(levels(factor(test$companyName)))
test
head(test)
levels(factor(test$companyName))
levels(factor(test$industryName))
test = reg.dat[is.na(reg.dat$state_co),]
levels(factor(test$companyName))
test
test = reg.dat[is.na(reg.dat$state_ind),]
levels(factor(reg.dat$companyName))
levels(factor(test$companyName))
dim(reg.dat)
length(levels(factor(reg.dat$companyName)))
length(levels(factor(reg.dat$industryName)))
reg.dat = reg.dat[!is.na(reg.dat$state_co) & !is.na(reg.dat$state_ind),]
dim(reg.dat)
length(levels(factor(reg.dat$companyName)))
length(levels(factor(reg.dat$industryName)))
1042-816
reg.dat = reg.dat[!is.na(reg.dat$npatappAdj),]
dim(reg.dat)
length(levels(factor(reg.dat$companyName)))
length(levels(factor(reg.dat$industryName)))
all.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = reg.dat)
summary(all.mod)
plot(fitted(all.mod), residuals(all.mod), xlab="Fitted", ylab="Residuals")
plot(fitted(all.mod), abs(residuals(all.mod)), xlab="Fitted", ylab="|Residuals|")
qqnorm(residuals(all.mod), ylab="Residuals") # Q-Q plot
outlierTest(all.mod, order=FALSE) # Bonferonni p-value for most extreme obs
sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/2, replace = FALSE)
sample.dat = reg.dat[sampleIndex,]
sample.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = sample.dat)
summary(sample.mod)
outsample.dat = reg.dat[-sampleIndex,]
yVect = outsample.dat$npatappAdj
curMean = mean(yVect)
curSSTot = sum((yVect-curMean)^2)
curPred = predict(sample.mod, outsample.dat)
curSSRes = sum((yVect-curPred)^2)
curR2= 1-(curSSRes/curSSTot)
curR2
ho.mod = lm(npatappAdj~state_co + I(state_co)^2+stError_co + state_ind +I(state_ind)^2 + stError_ind, data = reg.dat)
summary(ho.mod)
ho.mod = lm(npatappAdj~state_co + I(state_co^2)+stError_co + state_ind +I(state_ind^2) + stError_ind, data = reg.dat)
summary(ho.mod)
dim(reg.dat)
load("workCosonlynotstrict.RData")
industries.dat$onlyWorkingFlag = 0
missindstrict.dat = read.csv("missingindustriesstrict.csv")
keepInds = c(800,1400,1540,2090,2092,2300,2340,2451,2452,2611,2621,2840,2844,2870,2911,3089,3250,3270,3317,3360,3420,3430,3442,3444,3452,3550,3569,3571,3590,3630,3728,3812,3824,3844) #industries that run with strict restricition if only working companies are used
missindstrict.dat = missindstrict.dat[missindstrict.dat$industryName %in% keepInds,]
missindstrict.dat$strictFlag = 1
missindstrict.dat$onlyWorkingFlag = 1
industries.dat = rbind(industries.dat, missindstrict.dat)
missindnonstrict.dat = read.csv("missingindustriesnonstrict.csv")
keepInds = c(2430, 3433)
missindnonstrict.dat = missindnonstrict.dat[missindnonstrict.dat$industryName %in% keepInds,]
missindnonstrict.dat$strictFlag = 0
missindnonstrict.dat$onlyWorkingFlag = 1
industries.dat = rbind(industries.dat, missindnonstrict.dat)
companies.dat$id = paste(companies.dat$industryName, companies.dat$datayear, sep = "")
companies.dat$companyid = paste(companies.dat$companyName, companies.dat$datayear, sep = "")
industries.dat$id = paste(industries.dat$industryName, industries.dat$datayear, sep = "")
reg.dat = merge(x = companies.dat, y = industries.dat, by = "id", all.x = TRUE)
colnames(reg.dat) = c("id", "industryName", "companyName", "datayear", "state_co", "stError_co", "strictFlag_co", "companyid", "drop", "drop2", "state_ind", "stError_ind", "strictFlag_ind", "onlyWorkingFlag")
reg.dat= reg.dat[,c(1:8, 11:14)]
#reg.dat = merge(x = reg.dat, y = lhs.dat, by = "companyName", all.x = TRUE)
#add lhs variable
RDDATA$companyid = paste(RDDATA$gvkey, RDDATA$datayear, sep = "")
#keep only first entry with each company id
RDDATA = RDDATA[!duplicated(RDDATA[,c('companyid')]),]
#multiIDs= data.frame(freq(ordered(RDDATA$companyid), plot=FALSE))
#multiIDs = multiIDs[multiIDs$Frequence >1,]
reg.dat = merge(reg.dat, RDDATA, by = "companyid", all.x = TRUE) #problem arises here!
reg.dat.nodeletes = reg.dat
#delete any entries where company or industry model was not estimated for these years
reg.dat = reg.dat[!is.na(reg.dat$state_co) & !is.na(reg.dat$state_ind),]
#delete missing LHS--in this reduced sample there are no missing LHS's
reg.dat = reg.dat[!is.na(reg.dat$npatappAdj),]
#model
avgSpend = aggregate(reg.dat, by = "companyName", FUN = mean)
avgSpend = aggregate(reg.dat, by = reg,dat$companyName, FUN = mean)
avgSpend = aggregate(reg.dat, by = reg.dat$companyName, FUN = mean)
colnames(reg.dat)
avgSpend = aggregate(reg.dat$xrdAdj, by = list(companyName = reg.dat$companyName), FUN = mean)
avgSpend
avgSpend[1:10,]
reg.dat[reg.dat$companyName == "1117",]
avgSpend = aggregate(na.exclude(reg.dat$xrdAdj), by = list(companyName = reg.dat$companyName), FUN = mean)
avgSpend = aggregate(na.exclude(reg.dat$xrdAdj), by = list(companyName = na.exclude(reg.dat$companyName)), FUN = mean)
testdat = reg.dat[,c("companyName", "xrdAdj")]
testdat = na.exclude(testdat)
avgSpend = aggregate(testdat$xrdAdj, by = list(companyName = testdat$companyName), FUN = mean)
avfSpend
avgSpend
colnames(reg.dat)
testdat = reg.dat[,c("companyName", "state_co")]
testdat = na.exclude(testdat)
avgSpend = aggregate(testdat$state_co, by = list(companyName = testdat$companyName), FUN = mean)
testdat = reg.dat[,c("companyName", "xrdAdj")]
testdat = na.exclude(testdat)
avgSpend = aggregate(testdat$xrdAdj, by = list(companyName = testdat$companyName), FUN = mean)
testdat = reg.dat[,c("companyName", "state_co")]
testdat = na.exclude(testdat)
avgSpend2 = aggregate(testdat$state_co, by = list(companyName = testdat$companyName), FUN = mean)
plot.dat = merge(x = avgSpend, y = avgSpend2, by = "companyName", all.x = TRUE)
plot.dat
dim(plot.dat)
colnames(plot.dat)
colnames(avgSpend2)
testdat = reg.dat[,c("companyName", "xrdAdj")]
testdat = na.exclude(testdat)
avgSpend = aggregate(testdat$xrdAdj, by = list(companyName = testdat$companyName), FUN = mean)
colnames(avgSpend)= c("companyName", "xrdAdj")
testdat = reg.dat[,c("companyName", "state_co")]
testdat = na.exclude(testdat)
avgSpend2 = aggregate(testdat$state_co, by = list(companyName = testdat$companyName), FUN = mean)
colnames(avgSpend2)= c("companyName", "state_co")
plot.dat = merge(x = avgSpend, y = avgSpend2, by = "companyName", all.x = TRUE)
colnames(plot.dat)
plot(plot.dat$xrdAdj, plot.dat$state_co)
length(levels(factor(reg.dat$companyName)))
length(levels(factor(testdat$companyName)))
testdat = reg.dat[,c("companyName", "xrdAdj")]
testdat = na.exclude(testdat)
length(levels(factor(testdat$companyName)))
length(levels(factor(plot.dat$companyName)))
dim(plot.dat)
plot(plot.dat$xrdAdj, plot.dat$state_co)
