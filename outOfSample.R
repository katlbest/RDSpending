#NOTES:======================================================================

#libraries and functions====================================================================
library(plyr)
library(ggplot2)
library(descr)
library(tseries)
library(gridExtra)
library(reshape2)
library(MARSS)
library(KFAS)
library(car)
library(mlogit)
library(nnet)
library(MASS)
#library(lme4)

#clear workspace ==============================================================
  rm(list = ls())

#data i/o=======================================================================
  RDDATA = read.csv("RDDATA.csv") 
  #note: input file has been slightly modified by STATA and has date year and industry/year ID extracted
  CONCATID = read.csv("concat.csv")
  RDDATA$iyID = CONCATID$iyID
  RDDATA$datadate = as.Date(RDDATA$datadate, "%d%b%Y")
  RDDATA$datayear = as.numeric(format(RDDATA$datadate, format = "%Y"))
  RDDATA$npatappAdj = RDDATA$npatapp/RDDATA$sale

#create raw indexes=======================================================================
  #pull raw R&D index and patent index
    TEMP = RDDATA[,c("iyID", "xrdAdj")]
    TEMP = na.exclude(TEMP)
    TEMP = melt(TEMP, id = "iyID")
    INDTABLE = dcast(TEMP, iyID~variable, mean)
    INDTABLE2 = data.frame(freq(ordered(TEMP$iyID), plot=FALSE))
    INDTABLE2 = INDTABLE2[1:(nrow(INDTABLE2)-1),]
    INDTABLE2$iyID = rownames(INDTABLE2)
    INDTABLE2= INDTABLE2[,c(1,4)]
    INDTABLE = merge(x = INDTABLE, y = INDTABLE2, by = "iyID", all.x = TRUE)
    colnames(INDTABLE)= c("iyID", "rawRD", "RDCount")
    TEMP = RDDATA[,c("iyID", "npatappAdj")]
    TEMP = na.exclude(TEMP)
    TEMP = melt(TEMP, id = "iyID")
    TEMP2 = dcast(TEMP, iyID~variable, mean)
    TEMP3 = data.frame(freq(ordered(TEMP$iyID), plot=FALSE))
    TEMP3 = TEMP3[1:(nrow(TEMP3)-1),]
    TEMP3$iyID = rownames(TEMP3)
    TEMP3= TEMP3[,c(1,4)]
    INDTABLE = merge(x = INDTABLE, y = TEMP2, by = "iyID", all.x = TRUE)
    INDTABLE = merge(x = INDTABLE, y = TEMP3, by = "iyID", all.x = TRUE)
    colnames(INDTABLE)= c("iyID", "rawRD", "RDCount", "rawNumPat", "numPatCount")
    write.csv(INDTABLE,"C:/Users/Katharina/Documents/Umich/rdspend/rawindex.csv")

#create model inputs=======================================================================
  #set up RD only data for model input
    RDONLY = data.frame(gvkey = RDDATA$gvkey, xrdAdj = RDDATA$xrdAdj, datadate = RDDATA$datadate,sic = RDDATA$sic, datayear = RDDATA$datayear)
    RDONLY = RDONLY[order(RDONLY$gvkey),]
    NOMISS = na.exclude(RDONLY)
  
  #create input lists by industry 
    indList = levels(factor(RDONLY$sic))
    dataList = list()
    nameVector = c()
    for (i in 1:length(indList)){
      curData = RDONLY[RDONLY$sic ==indList[i],]
      #if (nrow(curData) > 50){
        dataList[[length(dataList)+1]]= curData
        nameVector[[length(nameVector)+1]]= indList[i]
      #}
    }

  #clean inputs for each industry
  oneVarList = list()
  numCosList = list()
  startYearList = list()
  for (i in 1:length(nameVector)){
    curData = dataList[[i]]
    curDataOneVar = ddply(curData, ~datayear, 
                          function(df) {
                            res = data.frame(rbind(df$xrdAdj)) #take R&D spending as a percentage of sales
                            names(res) = sprintf("%s",df$gvkey)
                            res
                          }
    )
    startYearList[[i]]= min(curDataOneVar$datayear)
    numCos = ncol(curDataOneVar)-1
    model.data = curDataOneVar[-c(1)] #delete time entry
    model.data = as.matrix(model.data)
    model.data = t(model.data)
    oneVarList[[i]]= model.data
    numCosList[[i]] = numCos
  }
  #reduce to usable variables
    redVarList = list()
    for (k in 1:length(oneVarList)){
      current=oneVarList[[k]]
      currenthold = current
      currenthold[currenthold == 0]= NA
      counters=apply(currenthold,1,function(x) sum(!is.na(x)))
      redVarList[[k]]=current[counters >6,] #remove companies that don't have at least 4 non-zero, non-NA entries, CHANGE HERE
      redVarList[[k]]= oneVarList[[k]]
      #print(dim(redVarList[[k]])[1]-dim(current)[1])
    } 

#print usable companies
#for (k in 1:length(oneVarList)){
  
  
#}

#run model=======================================================================================
  #note run this with at least 5 data points
  output.data = data.frame(matrix(ncol = 7, nrow = 0))
  colnames(output.data)= c("industryName", "logLik", "numParams", "AICc", "States", "SEs", "converge")
  output.outofsample = data.frame(matrix(ncol = 4, nrow = 0))
  colnames(output.outofsample) = c("industryName", "datayear", "state", "se")
  #missedList=c(3931,2590,3390,2520,2540,3221,3360,2531,3824,3570,3760,3942,3550,3567,3821,7384,2033,2111,2840,5160,3444,2833,2990,3562,9997,3561,3716,4822,5200,3452,3433,3442,3555,3844,7381,2013,2273,2851,2800,2820,3081,3678,2430,3630,3843,3270,3721,7320,7830,3523,3590,8734,5070,3290,5141,2000,3420,7380,3827,3851,5110,5051,5172,2060,2821,3569,3728,2040,5190,8090,2030,2400,2721,3711,5047,5080,8700,3580,3585,4700,2711,1382,7310,7371,2200,2870,3533,3944,8082,2860,3829,4412,1400,3861,2621,3949,3990,5065,7200,1389,3823,7359,3812,3640,8200,8742,3572,5122,3826,8071,2844,2750,5045,8731,8711,3825,3571,7374,2911,3312,7011,3089,3559,5411,3842,5961,4899,3841,4812,7990,7389,1040,9995,3845,5812,4813,7373,7370,7372,1044,1520,2084,2771,3281,3412,3911,4011,4013,4220,4222,4512,4513,5010,5050,5072,5082,5171,5180,5211,5271,5311,5331,5399,5531,5600,5621,5651,5944,5945,7340,7377,7997,8051,8111,8300,5661,5810,7350,7361,8062,8400,900,2790,4522,7000,7510,7996,8351,2732,3910,4100,5030,5731,8060,8900,2253,4213,4610,5000,5020,5712,5900,8050,2015,2044,4400,5064,5094,5130,5400,5735,8600,2085,2092,3211,5940,7822,5700,7819,5013,7829,8011,2421,5031,5099,5412,7841,8744,1540,3241,3451,5063,7331,8741,4210,5734,7311,8000,800,1531,2086,3873,2451,5090,7385,200,3430,2340,4581,4832,5093,5140,7948,1090,1731,7330,7500,2052,4731,7812,2300,2780,5912,1220,3720,1381,5150,7900,8093,2673,2741,5500,5960,2452,3960,3250,7600,3317,5990,8721,3751,2611,5084,2082,4833,1600,3822,5040,3950,3743,7363,2090,3790,3724,3480,4841,3730)
  for (k in 13:length(redVarList)){
    oneVarInput = redVarList[[k]]
    numCos = nrow(oneVarInput)
    numYears = 1
    industryName = nameVector[k] 
    #if (industryName %in% missedList){
    if (!(is.null(numCos))){ #meaning we have more than 1 company
      numYears = ncol(oneVarInput)
      if (numCos >1){
        #set model inputs
          BAll = "identity"
          QAll= "diagonal and unequal" #note this could be changed if it causes problems since the unequal portion is irrelevant (it is a 1 by 1 matrix)
          ZIN= rep(1, numCos)
          ZIN = as.list(ZIN)
          ZAll = matrix(ZIN, numCos, 1)
          RAll = "diagonal and equal"
          AAll = "equal"
          UAll = "zero" #TBD was zero
        #set model controls, if necessary
          control.list = list(safe = TRUE, trace =1, allow.degen= TRUE, maxit = 1000,conv.test.slope.tol=0.1)
          #TBD set conv.test.slope.tol to .1 or less to test for convergence
        #run models
          stringList = c()
          model.list = list(B=BAll, U=UAll, Q=QAll, Z=ZAll, A=AAll, R=RAll)
          model.current = MARSS(oneVarInput, model = model.list, miss.value =NA, control = control.list)
          if (is.null(model.current$num.params)){
            numParams = NA
            AICc = NA
            curStates = NA
            curSE = NA
            curConv = NA
            stateVect = rep(NA, numYears)
            seVect = rep(NA, numYears)
          } else{
            numParams = model.current$num.params
            AICc = model.current$AICc
            stateVect = model.current$states[1,]
            seVect = model.current$states.se[1,]
            curStates = toString(model.current$states)
            curSE = toString(model.current$states.se)
            curConv = model.current$converge
            #plot
              plotData = data.frame(t(model.current$states))
              seData = t(model.current$states.se[,1])
              origData = data.frame(t(oneVarInput))
              plotData$time = c(1:nrow(plotData))
              plotData$lb = plotData$state1 - 1.96 *seData[1] 
              plotData$ub = plotData$state1 + 1.96 *seData[1] 
              myPlot = ggplot(data=plotData, aes(x=time, y=state1)) + geom_line()  + geom_line(aes(x = time, y = lb), plotData, lty = 'dashed')+ geom_line(aes(x = time, y = ub), plotData, lty = 'dashed')+theme_bw() + labs(title=paste(industryName, sep = ","))
              j = 24
              for (i in 1:ncol(origData)){
                curInput = paste("curCo", i, sep = "")
                addString = paste("geom_point(aes(x = time, y = origData[,", i, "]), colour = ",j,")", sep = "")
                myPlot=  myPlot+ eval(parse(text = addString))
                j = j+5
              }
              ggsave(paste("C:/Users/Katharina/Documents/Umich/rdspend/firststage/industryConverge", industryName, ".pdf", sep = ""))
            }
          if (is.null(model.current$logLik)){
            logLik = NA
          }else{
            logLik = model.current$logLik
          }
        } else{
          numParams = NA
          AICc = NA
          curStates = NA
          curSE = NA
         logLik = NA
          model.current = NA
          curConv = NA
          stateVect = rep(NA,numYears)
          seVect = rep(NA, numYears)
        }
      } else{
        numParams = NA
        AICc = NA
        curStates = NA
        curSE = NA
        logLik = NA
        model.current = NA
        curConv = NA
        stateVect = rep(NA,numYears)
        seVect = rep(NA, numYears)
      }
      cur.outdata =data.frame(industry= industryName, logLik = logLik, numParams = numParams, AICc = AICc, states = curStates, ses = curSE, converge =curConv, stringsAsFactors = FALSE)
      colnames(cur.outdata)= colnames(output.data)
      output.data= rbind(output.data, cur.outdata)
      cur.outofsample = data.frame(matrix(ncol = 4, nrow = numYears))
      colnames(cur.outofsample) = colnames(output.outofsample)
      cur.outofsample$industryName = industryName
      cur.outofsample$datayear = c(startYearList[[k]]:(startYearList[[k]]+numYears-1))
      cur.outofsample$state = stateVect
      cur.outofsample$se = seVect
      output.outofsample = rbind(output.outofsample, cur.outofsample)         
      modelString = paste("IndEdit", industryName, sep = ".")
      stringList = c(stringList, modelString)
      assign(paste("IndEdit", industryName, sep = "."), model.current)
    #}
  }
  save.image(file = "IndEdit.RData")
  write.csv(output.data, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test2.csv")
  write.csv(output.outofsample, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test3.csv")
  IndEdit.out = output.outofsample
  save(IndEdit.out, file = "IndEdit.out.RData")

#company level models=================================================================
  #note run with 6 entries
  output.data = data.frame(matrix(ncol = 8, nrow = 0))
  colnames(output.data)= c("industryName", "companyName", "logLik", "numParams", "AICc", "States", "SEs", "converge")
  output.outofsample = data.frame(matrix(ncol = 5, nrow = 0))
  colnames(output.outofsample) = c("industryName", "companyName", "datayear", "state", "se")
  #myStr =  "c(9465,5709,2663,6375,7146,3126,4771,5862,6435,11446,6845,7435,7692,9555,10005,5894,8123,3607,4087,4060,1078,2403,6730,7257,8530,9459,8488,8762,10056,4213,1920,3170,4622,11096,4462,6078,10857,11012,5589,4926,2410,2991,9652,6830,8850,2008,3502,5234,9216,1593,8214,2787,10236,1243,1356,1988,9778,11094,9173,10124,1408,3580,8358,3835,2817,13003,1976,6386,6737,3041,6509,5959,10777,4108,10581,4036,1690,11361,4340,2721,11636,3946,8606,10441,1567,4321,8699,9203,1981,1706,3203,3497,10540,7980,10420,1635,3358,4128,7585,10364,2953,11161,4352,6008,6109,7346,10499,7506,4199,10195,11537,10983,10150,3662,5229,2444,5046,6774,4222,5860,8972,7828,7883,1598,6314,1968,3158,5621,6370,2220,7409,10530,2111,7420,10115,3786,9372,11115,4194,3612,10658,11509,6326,11213,2504,1891,3480,2771,5047,6543,5020,4843,6315,3171,2561,6908,5905,6506,9323,6494,6972,1166,1820,7281,5650,3785,10232,8759,4595,8546,10622,9818,6020,4140,9483,8087,1161,7469,7772,9599,9999,5932,3333,10275,11573,6013,4608,5691,7152,7481,8687,10550,7228,4925,1021,1677,6036,9048,10787,10853,9340,3116,1585,9230,8964,1783,11325,11124,5578,8423,10349,9311,6125,8594,9719,6512,6185,4415,5594,3310,7652,14102,4864,7662,4162,7602,2518,6171,6565,6169,6130,10553,6722,6003,7343,10200,6021,4274,9919,11217,3711,5165,15106,11694,7682,6158,4826,8559,8096,2352,1659,5944,14459,1111,4418,8068,1992,1969,6528,4086,7536,8333,7526,1602,15334,8257,4412,4507,9332,1606,8463,11749,10431,10382,6571,3055,1577,5973,5791,8253,3178,3735,9191,1056,4132,3916,1951,10734,11051,9969,8071,2049,2411,1500,11286,7576,10588,15005,1154,3505,2489,10312,4245,7504,8526,12180,4551,7601,12519,7705,12136,12053,6193,10599,13570,6159,12581,8633,4292,3820,1037,4296,1072,11646,15172,2433,12389,10549,6110,10685,12141,12540,11811,12826,28701,2597,7554,13839,14538,10321,12250,12274,2226,2797,11930,2888,7991,2215,7123,12256,13011,12472,1099,11678,2625,9602,5818,7106,13906,4168,6765,12877,3793,2058,4675,6096,8014,5988,2246,12390,13332,13623,8657,12206,3782,1627,11935,12679,13370,13824,12091,13633,2562,3422,14470,3911,11288,5798,13235,7551,6431,7777,15103,6044,9114,8051,8434,13169,8202,14623,8934,4585,1822,8562,14113,12051,13135,14064,3248,14170,6492,6152,5166,6608,13329,3892,14834,12677,14938,10359,14417,13328,6946,10004,14311,12944,8163,7192,14108,13619,14385,1115,4329,11805,3273,2616,10733,10252,6922,13940,9635,1334,3354,14169,5978,8543,13288,3375,6919,10855,2826,13786,11929,14597,15708,5902,10237,12381,7679,7475,1755,6531,2338,5066,6701,12262,17202,7938,5181,8637,14898,15293,15331,7822,10741,3282,5846,3769,3781,7416,12874,12518,14620,8960,14863,11312,14252,23170,12789,9598,9724,11907,8062,14282,4623,17828,2343,11261,14229,10163,5693,10304,4265,9051,14487,14808,4020,14894,2137,4312,5569,3277,11700,12226,12913,14268,14626,3773,16405,24370,4073,2965,9815,15752,30554,16453,5885,5841,4409,15414,2190,8902,1609,16650,10618,9556,5566,5928,3955,5869,16710,10422,3370,4413,13219,15327,14924,23197,18549,4671,15474,16597,5070,21238,4248,13176,3022,19911,1010,21496,10640,16188,5419,21792,7217,18100,17196,14386,6362,18699,6035,7817,2536,4806,7753,22794,18729,14447,21487,100243,11784,6803,13782,12578,9236,14304,13599,12691,23812,24179,24344,24197,24008,24468,6588,8517,24625,4940,1456,14883,23220,19731,15160,24405,10329,12400,8490,16401,2135,10537,4126,8280,19818,8573,15220,4283,11693,28206,23943,25621,24720,22839,22461,13556,5014,7182,8880,2891,24610,10583,11699,9074,21777,7205,101317,3935,5901,24185,13995,2141,11436,21232,1043,12560,11135,4530,20494,15855,16721,24352,10717,10458,24378,1940,13733,24198,8288,1429,25124,25870,10902,12580,21186,24710,24782,25937,27906,5886,24856,24878,5369,13483,1244,6776,22817,10526,7642,9932,10323,15711,14450,24293,3619,9285,10810,20993,21488,5247,3586,10107,9582,15354,25774,3684,7336,24475,25554,25929,5839,8990,3547,1250,3705,6467,10418,24800,24190,23767,25166,4962,11408,7099,17225,11475,14078,15133,3736,24925,24922,11908,24890,1652,15018,3520,3849,24021,24449,25110,25268)"
  #missedList = eval(parse(text=myStr))
  #myStr = "c(25279,28380,12597,24402,3053,13593,14512,24842,25579,24978,14396,25056,6717,25807,10724,24489,24975,25241,25302,25320,25341,25783,28384,2294,3683,9570,23080,28524,6403,11038,1498,8935,6102,9514,10326,24912,29274,28194,29392,20194,29278,16488,24728,14285,19069,25623,27845,7503,14622,15465,23605,27784,12397,119053,27920,28563,5574,8711,2593,29751,1537,15319,24105,12801,28176,28295,104598,7919,29001,28940,4545,7245,11797,28641,13699,28938,5345,5119,4987,14537,28386,28316,28374,100039,25747,6287,14036,21151,27828,10284,13442,21144,25978,1281,6308,28236,25848,28195,7344,13941,23717,23616,26015,28678,29386,2124,4639,21573,26019,5567,4763,1017,28477,12593,28712,29085,13197,29040,7059,20296,8829,10185,25313,23291,12570,16620,14897,25013,26246,9135,4975,10915,12075,29250,14100,104831,9930,3317,8726,10310,8497,16531,9686,25658,2308,7329,11751,13902,24436,25138,25859,28016,28383,5399,3957,12396,27913,5614,13840,21435,11396,29733,29942,4573,22049,25389)"
  #missedList2 = eval(parse(text=myStr))
  #myStr = "c(1430,100080,5825,15269,13407,15416,10243,11679,12828,24302,25648,29759,29955,29312,20333,28209,7823,29511,29939,4758,29008,29341,31479,10202,6180,14531,30260,27961,9180,31424,12436,6291,9679,28502,28884,30710,1642,10449,3253,4344,28775,7333,28001,14336,10754,12329,30847,5950,13841,6107,5764,12343,30614,2800,11058,13608,25844,30576,8917,12924,23671,29241,29722,30939,6477,13923,3938,22729,23496,28249,31142,31147,31255,5992,6408,29435,28724,14340,25791,28947,7077,28983,12548,12482,4280,1989,15315,14395,24304,22308,5555,4981,14581,8164,12481,30312,24743,11128,29705,4453,6892,9125,5941,8480,12337,13831,3762,23955,27771,27928,28758,29095,28744,29661,29709,30688,31143,31144,1073,21864,28145,30398,12178,6873,19306,100571,28286,8901,3746,12761,6376,30121,61596,7180,27924,12129,3395,10152,6129,25546,7694,19034,30137,25850,24191,24726,29992,3503,61616,3765,8957,4491,13351,29921,62671,14301,7953,11321,9997,30233,31477,31483,61814,30098,1050,22619,1055,13315,10255,24608,61513,3304,61752,8940,30718,61439,61552,31500,11347,8015,13408,61153,7139,24382,12356,3306,21204,30540,31843,61212,61712,10006,30029,31285,14005,21763,29322,29791,31488,60846,61592,61737,13423,61562,14383,28624,30463,60979,4159,1900,4900,10230,31881,61574,61706,30209,11766,9477,24376,25711,24662,31166,3712,1151,13474,61181,21673,5850,11373,5884,12163,15113,16437,29319,24888,26038,31887,61151,61285,25980,1094,24486,29127,25683,60893,7819,7345,10071,13070,102690,23777,24767,28325,29356,30094,31168,30870,60950,61069,61557,61570,61676,61685,61694,1054,2578,1896,12620,22823,18467,61902,12636,9603,29323,31578,19349,3702,14881,12323,14287,17525,17452,21506,7737,65112,11147,25164,26008,3244,13621,63637,65350,14628,2225,15446,17107,24110,28027,30451,61781,62700,63863,13161,61399,62784,62913,63385,64375,65011,2646,13282,13184,62921,63405,63789,3693,3872,61567,24205,100465,20525,61534,14854,9233,62984,65142,5805,25964,61575,63914,62221,102345,14546,65671,8927,24846,61356,61435,63600,66022,31093,13264,10330,28504,28078,12968,14250,30009,61591,65413,3148,11948,29366,65130,13914,63520,65552,65676,102696,65026,15761,30008,14569,7558,7946,61402,61646,62730,63671,9019,3796,19575,25149,62709,63240,64103,64282,12583,62824,62902,64637,65036,66032,201395,5976,10374,61922,65554,65590,9746,8862,63651,6482,28408,31567,65399,2519,28149,63477,61766,3040,25475,64340,7885,10153,10381,8165,13865,61398,61427,61560,64915,7903,4349,19953,63186,64595,62612,65421,13239,63676,63700,5113,15290,29459,61703,62948,3049,13374,13600,23776,14985,62960,62990,63100,65189,29497,10914,2197,61440,60900,62261,12364,3708,60931,62016,11218,62634,6046,10305,5660,6815,25091,25223,25944,28221,28764,29381,31423,31564,31660,31720,61077,61253,61498,61523,61726,61870,62201,62399,62460,62571,63080,63185,63281,63290,63476,64451,65242,65474,65899,2596,10826,12355,13828,25976,63220,63454,63959,64041,64089,64480,65380,65544,18484,62266,63663,2322,61355,61627,24353,212782,13468,108893,102983,66318,2962,64549,24749,10845,10846,6544,29965,62510,6782,1278,116504,66290,102422,112401,117862,110566,112759,13704,66496,112720,15803,25906,30007,64708,101310,112033,112408,212340,20492,64314,12275,30645,60875,12233,14257,30236,66588,66698,15283,28883,23135,23898,11070,15426,4819,65765,21892,16469,14281,2669,10053,29968,11764,11413,9111,66050,24365,5482,20747,4427,9005,61753,4781,7497,7101,64408,7234,25342,22139,3961,27903,61531,64397,6042,23486,10242,65527,110533,4285,9965,10804,9181,20309,5954,13378,17079,64356,112874,3831,25098,62324,64088,64111,64620,65244,65986,110685,28993,64351,29304,1905,64853,65643,65739,65904,66519,66708,109179,110760,6956,61721,25224,27873,64060,28917,1865,10443,2918,30832,117861,66300,14852,26374,13413,10378,26520,24686,28337,29133,65286,63945,65772,14655,24860,1234,61691,62200,13048,5557,13333,25924,63122,64017,10608,11971,63857,65911,112473,1798,9215,63070,6012,28998,15115,8084,9942,12434,63051,12366,64768,11708,15190,65236,66368,112111,110529,8658,9789,13391)"
  #missedList3 = eval(parse(text=myStr))
  #myStr = "c(12302,13909,14524,17560,20982,23076,23701,28190,60973,21959,31888,60942,61546,31616,61401,62511,63169,63640,63758,63938,61419,63057,63898,63928,64420,65491,65550,66723,103487,111579,111880,112413,113609,17366,61566,62608,64078,64009,62666,63099,63470,64383,66393,109826,117781,118003,28699,63384,113419,61536,1990,2960,65034,109425,24531,1640,6510,14009,15404,20889,62498,61988,63026,2879,5386,14344,2864,24991,31474,28321,5705,2033,9737,5522,3868,5133,27755,64054,28653,1533,13934,66073,11184,13308,20192,24454,30546,31418,25047,65261,65893,112968,1514,2648,31459,25514,25578,24386,29390,62632,63804,62263,112178,62382,65872,17890,61256,9923,2639,19364,133870,18811,2265,13027,4253,8090,9709,8004,65937,23978,1753,103159,12160,29287,66602,2457,7895,11483,2494,8428,11129,5131,65887,119217,11302,15267,63559,7931,12120,12654,20969,26247,31530,10455,7821,1779,14849,15176,25115,25748,29079,28355,120774,4144,3986,20800,24832,29069,20520,24517,30061,29005,7025,15312,6989,11336,19043,4604,9319,109258,14582,3663,14264,20903,24543,65342,113425,120860,2475,5138,14019,28853,62640,119513,61556,114611,9151,2908,6000,21743,117768,112158,116526,116770,121773,3300,4290,8583,63531,2450,28916,61081,64690,14638,11117,22978,17405,4873,13622,23097,115245,119275,25899,4668,1693,64057,113361,3135,3715,6844,20294,63081,11750,61496,3666,11160,12458,3371,8567,15470,23045,25390,24971,66697,27810,62954,109925,2214,9597,25212,60916,29485,113362,10375,9872,6179,65790,14370,7227,14112,114524,116772,8145,12489,12541,18087,22404,28700,28817,61558,24909,29263,62523,62965,63180,63498,65622,64099,64597,106900,112301,206211,64929,65226,65757,66326,109186,110721,111064,112624,116787,120134,120723,120822,121273,122159,123821,2253,8462,12365,25460,25375,28184,20381,105847,113270,121080,11249,6694,1497,7898,28942,24338,28690,63604,7287,15799,3235,15508,142540,1308,140569,29317,218399,29235,12567,18597,100956,12616,7495,2062,14258,10841,9823,8458,3558,12650,17436,213449,124254,9183,9631,9775,9967,10062,11949,13134,13393,2928,12369,17764,24068,17101,24220,16480,23000,27825,24843,30352,62977,63084,106179,111965,113533,140445,2244,61414,21136,133868,7219,12440,25458,26034,14836,27765,61899,111492,22957,62237,63996,122257,122315,127514,133871,138341,25114,63500,8022,13568,12157,15110,130041,16582,133726,8771,7017,2239,28691,8322,8127,14794,31105,125533,5037,4837,65850,13708,208057,63769,1012,4568,26511,11138,3724,4327,9474,14896,9994,30264,140027,4075,16475,25420,30781,23790,119233,137602,205131,15455,3910,28819,3314,23051,64507,61350,132502,3047,1724,28433,133949,134384,5853,6585,13265,28371,64186,110100,119574,121718,124319,125074,126322,138467,138921,3784,11363,10233,15451,9511,21684,25441,28064,64153,66447,126318,126417,135844,137434,1126,12255,12834,8918,11665,138901,10193,125604,8743,10160,2687,14554,62822,122678,4299,8558,10032,3963,15200,28533,63678,118401,117905,105251,120334,124355,125474,133304,141178,9050,14474,30565,66632,121143,121153,125014,126716,133732,137861,8618,124996,8025,9716,26042,66403,64485,117941,124599,125599,127114,128763,132740,133288,135966,138346,140904,141044,141236,141278,208068,209341,213412,233038,6511,2829,10276,114698,2920,8811,24401,25430,29930,61516,4920,8046,9656,118122,136648,11685,5361,6530,12740,142546,9617,14364,30989,8643,10788,11109,25004,126423,133905,3950,29066,108086,126554,137377,137667,140759,4269,65368,127455,136804,140042,141469,10089,133564,5584,64392,8223,14296,62395,133366,135165,138707,62688,12416,23487,24988,25076,17199,113646,65217,30181,3167,65819,8802,13410,10645,5277,221612,24395,220940,222642,129469,133104,122172,126297,126714,9434,12680,3482,16813,4263,15258,66448,21244,127282,15007,10859,4113,5548,10257,6199,121437,122537,124320,124358,127094,133766,134044,134164,137609,230796,124196,127436,6986,3645,3270,1939,4100,5951,11063,12608,14884,24167,27788,28585,29658,60928,60969,61102,61550,61718,62607,26360,63381,63984,66026,64341,66507,112752,66468,66582,118307)"
  #missedList4 = eval(parse(text=myStr))
  #myStr = "c(118321,118738,119394,65560,112820,118228,121493,122061,122841,122921,123094,123998,124038,124049,124638,124678,125274,126601,126734,129848,129850,129851,130040,132518,132758,133044,133430,133432,137576,137662,138521,139721,140679,223732,7722,10245,11083,12264,14861,25117,25864,66696,105483,121053,122902,133844,134447,137641,138613,8396,11494,112004,121656,10417,12456,13069,30178,11912,29033,9213,24345,62829,3730,135004,7727,63803,5118,63901,65243,127234,127481,133885,137803,3165,30675,27921,64014,2249,209382,25691,3837,21740,14048,6495,62686,2889,8900,8585,65238,29224,5964,25183,28579,10974,122265,9971,10082,30169,146074,6184,18369,25305,1081,101718,101020,100806,128978,2303,24493,4138,5476,4455,64965,12757,7505,7196,29252,61433,62826,62860,63990,21776,64515,64542,106501,22632,63645,101076,107769,117829,133468,138466,145512,223098,7337,3117,6644,2832,14186,23503,134308,12232,20907,24881,61723,62846,64412,102045,61655,112754,112881,140908,142106,145228,8064,25959,8998,100581,125434,141760,2548,241216,15070,15150,17611,1761,4672,31636,3467,8886,13218,13469,29784,9925,7875,10535,29311,64955,137573,146075,62403,5083,102412,2471,6318,1941,61226,5044,12596,9043,28981,141241,5603,9234,4367,66558,142811,6879,9246,64790,3305,4944,9553,10261,10869,4845,9029,29152,29918,61405,121319,62065,126722,5245,3854,1350,12872,21251,25384,27540,142956,7431,8744,14377,126615,3828,6891,10419,11202,13953,23004,11667,25786,28147,122099,128121,3320,3298,8748,125276,129624,141468,15402,28203,9196,2412,23858,1016,11130,13008,65245,6364,8909,210418,20031,138601,140910,25326,117178,1814,4109,9949,11088,24969,61690,1863,2899,8337,9068,10578,1647,7327,11332,10226,4123,12217,13939,25525,28848,29822,61392,107046,125360,137130,9809,3234,15824,30087,61471,31520,127174,129120,21563,107001,108582,132525,138501,138943,139662,140030,9580,13497,31045,138607,101689,138610,24306,31455,3969,10693,25927,61572,138602,114370,133944,135044,135945,137292,137310,137600,137704,141845,144115,145809,2491,60899,65494,10358,62240,65697,133367,19661,62557,4535,7873,139801,145979,145875,2905,144066,228598,29934,4420,12360,105950,141459,3942,31534,21320,4068,5629,27933,6407,15466,8189,62217,3894,111169,133504,2219,64675,66060,143526,145854,13220,14164,28138,65082,63029,65218,125000,138741,143421,145911,6045,24651,25841,62471,136725,144436,14248,2557,11199,25771,138843,5571,140081,61994,1802,10984,203480,133866,9844,8044,62396,210216,222648,15337,29266,62317,26506,65686,146206,24655,13204,62269,62631,2751,24368,25000,122355,29081,136646,65624,64360,121478,124435,25805,61182,119273,120816,122674,124198,130498,132482,133547,137435,137611,140046,143527,13321,211009,10264,1795,10090,9790,13420,24509,28618,28756,26821,31515,60797,60868,60901,61573,62005,62447,63203,65466,66070,64029,64036,64423,65072,24478,120300,122436,122447,123937,126597,127438,128618,129419,132405,132718,134104,137252,31055,64021,64152,123356,124036,127075,127462,130049,133364,133825,133888,138402,138611,138621,10789,10229,3716,14992,14943,16452,28961,63474,122101,119736,120595,64907,108588,144437,224796,3707,125358,1228,65457,63980,9013,12350,122094,62257,25396,141197,127279,142748,10452,60964,62475,65169,138123,24768,143357,21469,29803,10971,30443,121722,2957,2209,9587,5936,101096,12335,148276,1729,1643,5669,26405,13963,120877,11605,27846,7001,20036,7489,25923,6478,5381,6242,3704,5368,9110,148309,26044,100004,101202,7724,9027,148256,7392,10066,10360,8665,4436,8012,12713,24106,25243,25813,27756,29476,27988,30775,133731,134685,138705,205950,61166,140443,65666,101204,121440,140044,24667,24935,31484,137801,138203,66683,151016,3729,9120,62993,108564,212639,138781,63246,65553,206184,211897,133246,2057,1239,6568,101050,123754,30191,148271,140024,63448,117782,10001,222111,3810,4049,7078,9703,3102,11333,12943,28831,61462,148310,9620,1020,100477,13582,25647,5532,1789,22623,1357,146352,31600,28157,9981,1564,60993,11039,13087,15108,143912,14469,30660,137373,22360,65313)"
  #missedList5 = eval(parse(text=myStr))
  #myStr = "c(148250,2039,5775,128759,31256,1696,28811,17420,7160,5293,8686,138342,3352,10406,3485,1692,6359,28117,62975,11627,24791,64177,5604,7522,61027,62295,2413,6309,12359,13164,14630,24357,30131,28971,29575,120455,3944,3344,30239,62167,3755,1033,7247,27894,2310,4372,133004,66629,31167,12831,3155,14472,13944,25015,4088,29092,146017,6470,9410,7246,61246,3401,9390,10269,2890,4169,6023,13015,21106,21501,24548,25723,25619,29763,61744,62750,61065,26277,129467,2853,20797,19595,64279,128698,20209,64668,29170,108246,138347,147288,3098,6117,11205,64654,3756,13780,62768,7531,25674,28766,61410,66450,132986,134932,135805,138612,7960,3783,142814,13960,23890,11645,1517,19113,63547,18466,15313,25916,65046,64511,100609,148328,1908,10298,12154,15050,64634,148349,1847,145984,6628,10088,4301,4776,121759,6715,7044,8943,1824,13414,24281,4006,10377,28279,29411,61048,64809,136824,141076,141665,100245,148390,1970,9929,6747,138483,128663,138205,29414,20210,23196,60906,117142,147644,10231,24505,25222,61059,65109,141321,141384,31015,62923,4264,21606,2236,105230,63297,65016,64132,147451,148870,147449,5708,6423,23968,61351,63445,122317,14227,12121,30070,148410,26009,6430,6663,12289,15221,64539,223911,4932,7593,9830,8286,24342,222640,106815,122358,127464,147750,254338,2902,141239,22248,133327,3552,64488,1023,6006,2083,3065,13670,120773,7427,121673,7773,62388,113490,17440,4421,15333,28973,60948,63836,65045,62924,65841,109920,119173,120634,133525,122536,124359,128599,133186,134025,124934,132980,137881,31381,108234,136828,147660,211322,3753,10798,3515,9551,12883,14816,24067,24793,24622,24733,25271,28382,25801,27940,28010,26264,30835,31622,60883,26852,60897,62581,62859,63324,63328,63821,63822,63894,65533,63648,220748,64038,64283,114961,118445,120156,120839,123995,126599,130398,134031,134452,140049,221237,112620,121793,133769,64492,108829,115554,127177,133869,138201,138210,144135,147452,8629,1942,10250,1904,20991,25225,27969,30639,61928,61432,121139,122895,107027,135965,147849,3789,6420,7110,1434,61159,10404,14232,132524,63757,5942,147579,9607,13601,12228,65978,9069,4456,14789,29789,113530,65440,14263,138122,10357,63899,65042,137884,11706,62304,62401,110962,14002,24900,10385,4120,23262,3930,8440,61535,3633,30923,140071,13005,5055,10793,15087,147202,11424,65585,2946,64526,12825,9113,100135,3311,20118,8612,18636,3013,4579,12566,7770,3176,1251,3120,28521,6740,3100,156861,29638,25851,30806,4454,147565,31352,13326,25331,2987,157075,2827,14079,30025,31689,148293,6414,9031,13765,14290,14566,20899,13283,24661,24689,29650,30405,30938,63082,31706,61745,127384,201088,138404,24898,66374,100418,112814,133724,138608,24036,27973,63442,66416,14603,27522,100423,63374,128098,146156,28894,28937,30742,25095,30674,62809,63162,29837,112001,113460,64335,29464,29729,63151,136884,108794,120051,9126,11182,30325,100587,9316,12049,23606,24894,4176,15102,7476,15251,114303,220546,148210,61576,9004,2264,18480,11274,8769,11155,10218,12284,65152,148213,144058,3128,28462,9639,5086,124074,30807,106989,146117,9188,23420,64894,1365,29120,6745,10721,15127,22257,7527,1613,2872,3017,66045,1645,6427,11098,28828,64254,119957,124775,10048,2794,30383,64271,29951,147101,1674,29369,20279,21438,2998,8035,6777,31063,6503,25662,28642,30068,30187,28630,64713,7177,14375,18876,103307,144821,9947,7490,13588,13615,63339,10384,62377,150937,2112,4451,11620,4146,23875,25352,25398,29119,29659,30034,30203,31757,61093,3913,9444,9492,23282,27785,30031,61684,62420,63007,154039,14177,62702,62213,4150,101936,11221,13611,21542,8889,30005,4295,30122,6937,11466,12739,9157,7373,9730,3020,29836,60920,157055,24953,22373,6847,3959,10263,10395,25200,28910,30703,30625,31666,31687,110766,125357,100114,145518,140979,9503,9912,27197,30844,61370,31193,61375,62738,61198,100699,107935,1888,9723,23876,31620,61088,61359,64005,121613,138603,138961,25274,154434,155735,156125,156153,242977,30696,3962,66275,8701,2831,13262,29762,66034,141099,100737,14339,29625,30863,62742,149477,157415,2898,5004)"
  #missedList6 = eval(parse(text=myStr))
  #myStr = "c(64313,1159,20992,63666,15252,145702,2048,6028,9395,1216,5021,13424,15277,4170,9097,9178,1649,1093,9769,29271,28529,29314,1872,29950,61553,141098,100401,25317,27789,31635,31300,6098,6499,5957,10259,28019,133164,24867,25086,30361,62236,9773,22859,23787,64680,148270,145003,24859,31097,62728,64497,139922,62077,145043,3738,13014,64611,5880,14925,31204,25779,65658,102450,11612,27760,24695,220579,8287,19625,221616,124322,217200,203944,241159,30102,1122,61700,124394,14843,233149,135865,9416,4147,11313,61381,5453,29310,2158,64028,121762,63674,10398,13924,29694,5465,3309,1601,24224,10038,1414,7758,13638,4909,132504,132361,1933,12702,126454,12304,19438,24680,29374,25629,60970,63233,65163,119081,117358,105655,121834,62079,66309,114184,1634,17542,19155,61068,3316,9788,1958,12502,12542,12558,17235,20906,22998,22790,23089,23123,24315,24335,15859,21507,24723,28165,28794,29236,20588,29139,29761,30084,21543,31571,31679,60933,61385,61927,27332,60955,61541,61642,62925,63018,63771,63955,64927,64950,65024,65866,25671,66657,66713,111671,116588,117904,111205,111488,119696,107415,121433,121720,121754,121842,122677,124318,129519,133024,133425,225088,61243,138000,138744,141381,114200,122235,132369,133728,143869,122655,140633,141957,142318,143668,156613,7638,10248,5143,10830,12619,14534,22059,25613,25622,30240,20535,62133,62966,64173,64863,65175,1360,63915,64884,65081,65825,120296,140061,158473,12635,128541,11211,29339,64631,31734,127378,157413,28026,8868,14374,30206,19613,62465,12073,24389,24948,25789,5994,3915,15475,24385,24907,27927,30980,61871,135247,28862,61255,112966,14286,19941,27912,24484,30611,137069,139985,30807,106989,146117,9188,23420,64894,1365,29120,6745,10721,15127,22257,7527,1613,2872,3017,66045,1645,6427,11098,28828,64254,119957,124775,10048,2794,30383,64271,29951,147101,1674,29369,20279,21438,2998,8035,6777,31063,6503,25662,28642,30068,30187,28630,64713,7177,14375,18876,103307,144821,9947,7490,13588,13615,63339,10384,62377,150937,2112,4451,11620,4146,23875,25352,25398,29119,29659,30034,30203,31757,61093,3913,9444,9492,23282,27785,30031,61684,62420,63007,154039,14177,62702,62213,4150,101936,11221,13611,21542,8889,30005,4295,30122,6937,11466,12739,9157,7373,9730,3020,29836,60920,157055,24953,22373,6847,3959,10263,10395,25200,28910,30703,30625,31666,31687,110766,125357,100114,145518,140979,9503,9912,27197,30844,61370,31193,61375,62738,61198,100699,107935,1888,9723,23876,31620,61088,61359,64005,121613,138603,138961,25274,154434,155735,156125,156153,242977,30696,3962,66275,8701,2831,13262,29762,66034,141099,100737,14339,29625,30863,62742,149477,157415,2898,5004,64313,1159,20992,63666,15252,145702,2048,6028,9395,1216,5021,13424,15277,4170,9097,9178,1649,1093,9769,29271,28529,29314,1872,29950,61553,141098,100401,25317,27789,31635,31300,6098,6499,5957,10259,28019,133164,24867,25086,30361,62236,9773,22859,23787,64680,148270,145003,24859,31097,62728,64497,139922,62077,145043,3738,13014,64611,5880,14925,31204,25779,65658,102450,11612,27760,24695,220579,8287,19625,221616,124322,217200,203944,241159,30102,1122,61700,124394,14843,233149,135865,9416,4147,11313,61381,5453,29310,2158,64028,121762,63674,10398,13924,29694,5465,3309,1601,24224,10038,1414,7758,13638,4909,132504,132361,1933,12702,126454,12304,19438,24680,29374,25629,60970,63233,65163,119081,117358,105655,121834,62079,66309,114184,1634,17542,19155,61068,3316,9788,1958,12502,12542,12558,17235,20906,22998,22790,23089,23123,24315,24335,15859,21507,24723,28165,28794,29236,20588,29139,29761,30084,21543,31571,31679,60933,61385,61927,27332,60955,61541,61642,62925,63018,63771,63955,64927,64950,65024,65866,25671,66657,66713,111671,116588,117904,111205,111488,119696,107415,121433,121720,121754,121842,122677,124318,129519,133024,133425,225088,61243,138000,138744,141381,114200,122235,132369,133728,143869,122655,140633,141957,142318,143668,156613,7638,10248,5143,10830,12619,14534,22059,25613,25622,30240,20535,62133,62966,64173,64863,65175,1360,63915)"
  #missedList7 = eval(parse(text=myStr))
  #myStr = "c(64884,65081,65825,120296,140061,158473,12635,128541,11211,29339,64631,31734,127378,157413,28026,8868,14374,30206,19613,62465,12073,24389,24948,25789,5994,3915,15475,24385,24907,27927,30980,61871,135247,28862,61255,112966,14286,19941,27912,24484,30611,137069,139985)"
  #missedList8 = eval(parse(text=myStr))
  #missedList = c(missedList, missedList2, missedList3, missedList4, missedList5, missedList6, missedList7, missedList8)
  #set model inputs
  BAll = "identity"
  QAll= "diagonal and unequal" #note this could be changed if it causes problems since the unequal portion is irrelevant (it is a 1 by 1 matrix)
  AAll = "equal" #company inputs are allowed to have trends
  UAll = "equal" 
  RAll = "diagonal and equal"
  ZAll = matrix(1,1,1)

  #set model controls, if necessary
    control.list = list(safe = TRUE, trace =1, allow.degen= TRUE, maxit = 1000,conv.test.slope.tol=0.1)
  #run models
  stringList = c()
    for (i in 1:length(oneVarList)){ #industry loop 
      curData = oneVarList[[i]]
      industryName = nameVector[i] 
      companyNameVector = rownames(curData)
      for (j in 1:(nrow(curData))){#for each company, run model
        #set up inputdata
          companyName = companyNameVector[j]
          #if (companyName %in% missedList){
          coData = curData[j,]
          if (length(coData[is.na(coData)])<length(coData)){
            nonNA1 = which(!is.na(coData)) #coData now a vector
            startIndex1 = min(nonNA1)
            endIndex1 = max(nonNA1)
            coData = coData[startIndex1:endIndex1]
            #if (!(is.null(numCos))){ #meaning we have more than 1 company
            numYears = length(coData)
            #TBD checks for missingness
            #run model
            model.list = list(B=BAll, U=UAll, Q=QAll, A=AAll, R=RAll,  Z=ZAll)
            model.current = MARSS(coData, model = model.list, miss.value =NA, control = control.list)
            #store output
            if (is.null(model.current$num.params)){
              print("failone")
              numParams = NA
              AICc = NA
              curStates = NA
              curSE = NA
              curConv = NA
              stateVect = rep(NA, numYears)
              seVect = rep(NA, numYears)
            } else{
              numParams = model.current$num.params
              AICc = model.current$AICc
              stateVect = model.current$states[1,]
              seVect = model.current$states.se[1,]
              curStates = toString(model.current$states)
              curSE = toString(model.current$states.se)
              curConv = model.current$converge
            }
            if (is.null(model.current$logLik)){
              logLik = NA
            }else{
              logLik = model.current$logLik
            }
          } else{
            print("failtwo")
            numParams = NA
            AICc = NA
            curStates = NA
            curSE = NA
            curConv = NA
            numYears = 1
            stateVect = rep(NA, numYears)
            seVect = rep(NA, numYears)
            logLik = NA
            model.current = NA
          }
     #note we took out an else here since we are not checking to make sure we have companies TBD   
      #store
          cur.outdata =data.frame(industry= industryName,company= companyName, logLik = logLik, numParams = numParams, AICc = AICc, states = curStates, ses = curSE, converge =curConv, stringsAsFactors = FALSE)
          colnames(cur.outdata)= colnames(output.data)
          output.data= rbind(output.data, cur.outdata)
          cur.outofsample = data.frame(matrix(ncol = 5, nrow = numYears))
          colnames(cur.outofsample) = colnames(output.outofsample)
          cur.outofsample$industryName = industryName
          cur.outofsample$companyName = companyName
          cur.outofsample$datayear = c(startYearList[[i]]:(startYearList[[i]]+numYears-1))
          cur.outofsample$state = stateVect
          cur.outofsample$se = seVect
          output.outofsample = rbind(output.outofsample, cur.outofsample)         
          modelString = paste("CoEdit", industryName,companyName, sep = ".")
          stringList = c(stringList, modelString)
          assign(paste("CoEdit", industryName, sep = "."), model.current)
          #}
      }
    }
  save.image(file = "CoEdit.RData")
  write.csv(output.data, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test2.csv")
  write.csv(output.outofsample, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test3.csv")
  coEdit.out = output.outofsample
  save(coEdit.out, file = "allCoOutMissed.RData") #i = 330, j = 96/141

#simple Kalman for companies===============================================================
kf
ks
SSModel(y, Z = NULL, H = NULL, T = NULL, R = NULL,
        Q = NULL, a1 = NULL, P1 = NULL, P1inf = NULL, u = NULL,
        distribution = c("Gaussian", "Poisson", "Binomial"),
        transform = c("none", "ldl", "augment"),
        tolF = .Machine$double.eps^0.5,
        tol0 = .Machine$double.eps^0.5)
myMod = SSModel(coData, Z=matrix(1,1,1), H = "diagonal and equal", T = matrix(1,1,1), R = matrix(1,1,1), Q = "diagonal and equal")
KFS(myMod)
  output.data = data.frame(matrix(ncol = 8, nrow = 0))
  colnames(output.data)= c("industryName", "companyName", "logLik", "numParams", "AICc", "States", "SEs", "converge")
  output.outofsample = data.frame(matrix(ncol = 5, nrow = 0))
  colnames(output.outofsample) = c("industryName", "companyName", "datayear", "state", "se")
  #set model inputs
    BAll = "identity"
    QAll= "diagonal and unequal" #note this could be changed if it causes problems since the unequal portion is irrelevant (it is a 1 by 1 matrix)
    AAll = "equal" #company inputs are allowed to have trends
    UAll = "equal" 
    RAll = "diagonal and equal"
    ZAll = matrix(1,1,1)

#set model controls, if necessary
control.list = list(safe = TRUE, trace =1, allow.degen= TRUE, maxit = 1000)
#run models
stringList = c()
for (i in 1:length(oneVarList)){ #industry loop 
  curData = oneVarList[[i]]
  industryName = nameVector[i] 
  companyNameVector = rownames(curData)
  for (j in 1:(nrow(curData))){#for each company, run model
    #set up inputdata
    companyName = companyNameVector[j]
      coData = curData[j,]
      if (length(coData[is.na(coData)])<length(coData)){
        nonNA1 = which(!is.na(coData)) #coData now a vector
        startIndex1 = min(nonNA1)
        endIndex1 = max(nonNA1)
        coData = coData[startIndex1:endIndex1]
        #if (!(is.null(numCos))){ #meaning we have more than 1 company
        numYears = length(coData)
        #TBD checks for missingness
        #run model
        model.list = list(B=BAll, U=UAll, Q=QAll, A=AAll, R=RAll,  Z=ZAll)
        model.current = MARSS(coData, model = model.list, miss.value =NA, control = control.list)
        #store output
        if (is.null(model.current$num.params)){
          print("failone")
          numParams = NA
          AICc = NA
          curStates = NA
          curSE = NA
          curConv = NA
          stateVect = rep(NA, numYears)
          seVect = rep(NA, numYears)
        } else{
          numParams = model.current$num.params
          AICc = model.current$AICc
          stateVect = model.current$states[1,]
          seVect = model.current$states.se[1,]
          curStates = toString(model.current$states)
          curSE = toString(model.current$states.se)
          curConv = model.current$converge
        }
        if (is.null(model.current$logLik)){
          logLik = NA
        }else{
          logLik = model.current$logLik
        }
      } else{
        print("failtwo")
        numParams = NA
        AICc = NA
        curStates = NA
        curSE = NA
        curConv = NA
        numYears = 1
        stateVect = rep(NA, numYears)
        seVect = rep(NA, numYears)
        logLik = NA
        model.current = NA
      }
      #note we took out an else here since we are not checking to make sure we have companies TBD   
      #store
      cur.outdata =data.frame(industry= industryName,company= companyName, logLik = logLik, numParams = numParams, AICc = AICc, states = curStates, ses = curSE, converge =curConv, stringsAsFactors = FALSE)
      colnames(cur.outdata)= colnames(output.data)
      output.data= rbind(output.data, cur.outdata)
      cur.outofsample = data.frame(matrix(ncol = 5, nrow = numYears))
      colnames(cur.outofsample) = colnames(output.outofsample)
      cur.outofsample$industryName = industryName
      cur.outofsample$companyName = companyName
      cur.outofsample$datayear = c(startYearList[[i]]:(startYearList[[i]]+numYears-1))
      cur.outofsample$state = stateVect
      cur.outofsample$se = seVect
      output.outofsample = rbind(output.outofsample, cur.outofsample)         
      modelString = paste("modelMissed", industryName,companyName, sep = ".")
      stringList = c(stringList, modelString)
      assign(paste("coModel", industryName, sep = "."), model.current)
    }
}
save.image(file = "coModelsMissed.RData")
write.csv(output.data, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test2.csv")
write.csv(output.outofsample, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test3.csv")
allMissed.out = output.outofsample
save(allMissed.out, file = "allCoOutMissed.RData") #i = 330, j = 96/141

#company level diagnostics=================================================================
output.data = data.frame(matrix(ncol = 6, nrow = 0))
colnames(output.data)= c("industryName", "companyName", "numTot", "numZero", "numNA", "yearsRun")

for (i in 1:length(oneVarList)){ #industry loop 
  curData = oneVarList[[i]]
  industryName = nameVector[i] 
  companyNameVector = rownames(curData)
  for (j in 1:(nrow(curData))){#for each company, run model
    #set up inputdata
    companyName = companyNameVector[j]
    coData = curData[j,]
    numTot = length(coData)
    numNA = length(coData[is.na(coData)])
    noNA = na.exclude(coData)
    numZero = length(noNA[noNA==0])
    numYears = 0
    if (length(coData[is.na(coData)])<length(coData)){
      nonNA1 = which(!is.na(coData)) #coData now a vector
      startIndex1 = min(nonNA1)
      endIndex1 = max(nonNA1)
      coData = coData[startIndex1:endIndex1]
      numYears = length(coData)
    }
      #store
    cur.outdata =data.frame(industry= industryName,company= companyName, numTot = numTot, numZero = numZero, numNA = numNA, numYears = numYears, stringsAsFactors = FALSE)
    colnames(cur.outdata)= colnames(output.data)
    output.data= rbind(output.data, cur.outdata)
  }
}
write.csv(output.data, file = "C:/Users/Katharina/Documents/Umich/RDSpend/test2.csv")

#outofsampletesting============================================================================
  #clear workspace
    rm(list = ls())
  #data i/o
    companies.dat = read.csv("C:/Users/Katharina/Documents/Umich/rdspend/outofsample/codata.csv") 
    industries.dat = read.csv("C:/Users/Katharina/Documents/Umich/rdspend/outofsample/inddata.csv", stringsAsFactors = FALSE) 
    lhs.dat = read.csv("C:/Users/Katharina/Documents/Umich/rdspend/lhsdat.csv") 
  #aggregate dataset
    companies.dat$id = paste(companies.dat$industryName, companies.dat$datayear, sep = "")
    industries.dat$id = paste(industries.dat$industryName, industries.dat$datayear, sep = "")
    reg.dat = merge(x = companies.dat, y = industries.dat, by = "id", all.x = TRUE)
    colnames(reg.dat) = c("id", "industryName", "companyName", "datayear", "state_co", "stError_co", "convergence_co", "drop", "drop2","rawRD_ind", "state_ind", "stError_ind", "convergence_ind")
    reg.dat= reg.dat[,c(1:7, 10:13)]
    reg.dat = merge(x = reg.dat, y = lhs.dat, by = "companyName", all.x = TRUE)
    #write.csv(reg.dat,"C:/Users/Katharina/Documents/Umich/rdspend/test.csv") 
  #clean out NAs
    #delete if not converged
      reg.dat = reg.dat[!is.na(reg.dat$convergence_co)& !is.na(reg.dat$convergence_ind),]
    #delete if no state available (this means that this model was not estimated for these years)
      reg.dat = reg.dat[!is.na(reg.dat$state_co) & !is.na(reg.dat$state_ind),]
      #this also deletes all without standard errors
    #delete missing LHS
      reg.dat = reg.dat[!is.na(reg.dat$npatappAdj),]
  #diagnostic plots
    #whole model
      all.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = reg.dat)
    #fitted versus residuals 
      plot(fitted(all.mod), residuals(all.mod), xlab="Fitted", ylab="Residuals")
    #fitted versus abs(residuals)
      plot(fitted(all.mod), abs(residuals(all.mod)), xlab="Fitted", ylab="|Residuals|")
    #QQ
      qqnorm(residuals(all.mod), ylab="Residuals") # Q-Q plot
      qqline(residuals(all.mod))
    #pairwise plot for linearlity
      pairs(reg.dat, panel=panel.smooth) #this takes forever
    #outliertest
      outlierTest(all.mod, order=FALSE) # Bonferonni p-value for most extreme obs
  #regression
    #all data, sampled
      sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/2, replace = FALSE)
      sample.dat = reg.dat[sampleIndex,]
      sample.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = sample.dat)
      #out of sample
        outsample.dat = reg.dat[-sampleIndex,]
        yVect = outsample.dat$npatappAdj
        curMean = mean(yVect)
        curSSTot = sum((yVect-curMean)^2)
        curPred = predict(sample.mod, outsample.dat)
        curSSRes = sum((yVect-curPred)^2)
        curR2= 1-(curSSRes/curSSTot)
    #remove outliers, sampled
      #outliers = c(900231,900031,900271,900131,900331,900111,900291,899991,900351,900391,900051,899971,900071,900151,900211,900191,900011,900171,900251,900311,900091,900371,1127429,1127525,1127453,1127513,1127561,1127573,1127477,1127489,1127441,1127537,1127549,1127417,1127501,1127465,1233240,1233226,1233156,1233184,1233114,1233212,1233128,1233268,1233142,1233254,1233198,1233100,1233086,1233170,1296882,1191829,1191834,1191814,1191844,1296890,1191809,1191839,1191859,1191824,1191819,1191804,1191854,1191849,1296866,1296874,1296842,1296850,1296898,1296858,1297309,1297319,1297324,1297314,1297329,1412691,1412707,1412699,1412715,1412667,1412675,1412651,1412683,1412659,900241,1153563,1153595,1153587,1153555,1153571,1153603,1153539,1153579,1153547,1153531,900041,900281,900141,900341,900121,900301,900001,900361,900401,900061,899981,900081,1314605,1314595,1314600,1314610,1314590,900161,900221,900201,900021,900181,900261,900321,900101,900381,1379257,1379293,1379284,1379275,1165367,1165334,1379311,1165213,1165345,1379302,1165290,1165268,1165246,1379329,1165323,1165312,1165224,1379320,1165279,1165301,1165257,1441104,1165235,1379266,1165356,1441114,1441099,1441094,1441109,1117451,1117424,1117442,1117379,1117406,1117388,1117433,1117397,1117415,976858,976892,977045,977062,977113,977079,976960,976926,976875,976909,976977,977096,977028,977147,977130,977011,976943,976994,1296878,1296886,1296862,911620,911710,911785,911650,911575,1296870,911665,911770,911725,911740,911635,1296838,911695,911590,911680,1413754,1413727,1296846,1413745,911605,1413709,1413736,1413772,1413763,911755,1413781,1413718,1296894,1296854)
      #outliers = c(outliers,1152680,1152799,1152901,1152697,1152918,1152884,1152748,1152816,1152833,1152714,1152765,1152935,1152782,1152731,1152850,1152867,1165366,1165333,1165212,1288655,1288676,1288697,1288669,1288704,1288683,1288662,1288690,1288648,1165344,1165289,1165267,1165245,1165322,1245120,1165311,405433,1165223,405604,1165278,405471,1245115,1165300,405414,405680,405490,405661,405623,1165256,286535,286346,286616,286211,286238,286751,286481,286778,286265,405585,286508,1165234,286373,405718,286589,286157,286805,286670,286103,286292,286454,286724,286130,286562,286319,286697,286643,405642,286184,286400,286427,1165355,1245090,405775,1245095,405737,1245110,405566,405528,405452,405547,1341665,1245105,1341692,1341683,1341647,1341656,1341701,1245100,1341638,1341710,1341674,405699,1127427,405794,1127523,1127451,1127511,1127559,1127571,1127475,1127487,1127439,1127535,1127547,1127415,1127499,1127463,1423849,1423876,1423885,1128473,1423867,1128463,1423858,1128458,405756,1423831,1128453,1423840,1128468,1423894,1423822,1415842,405509,1415824,1415812,900246,1118548,1415830,1425403,1118713,1415818,1425424,1118608,900046,1425431,1415836,1118668,1425410,1054635,1425438,1118728,900286,1425396,1118683,1054779,1118578,1425417,1054767,900146,1118653,1054755,1118518,900346,1118698,1054707,1118533,1054791,900126,1118563,1054611,1118623,900306,1054683,1118638,1054623,900006,1118593,1054803,900366,1054815,900406,1054695,900066,1054671,899986,1054719,900086,900166,1054731,900226,1054659,900206,1425670,1054647,900026,900186,1054743,900266,900326,900106,1376117,900386,1126409,1126222,1126375,1126426,1126324,1126273,1126256,1126358,1126443,1126341,1126239,1126205,1126307,1126460,1126290,1126188,911625,1376165,911715,911790,1126392,911655,1425680,911580,911670,1376149,911775,1316083,911730,911745,911640,1137001,911700,911595,1316090,1341667,1376069,1341694,911685,1341685,1341649,1341658,1341703,1341640,1153780,1153793,1153676,1341712,1341676,1316104,1153819,1153728,1153702,1153715,1153767,1153689,1153754,436199,436124,1153806,436449,435924,436474,435999,436374,436399,436049,435974,436499,436024,1376181,436174,436424,1424717,436074,911610,436249,436274,435899,436149,436224,436324,436299,436349,435949,1424773,1424733,1316076,1424757,1424749,436099,1137025,911760,1424741,1425675,1376085,1316111,1424765,1316097,1376021,1316118,1137013,1153663,1188630,1376133,1376037,1424725,1188639,1137019,1233232,1376053,1188657,1188612,1375941,1425665,1153741,1188603,1137031,1188648,1188621,1376101,1188675,1188666,1415844,1375989,1347417,1318554,1347427,1347437,1347487,1347497,1137007,1375973,1318569,1347457,1347477,1347447,1318549,1415826,1347467,1375957,1318564,1347407,1233218,1318559,1376005,1415814,1425660,1024366,1024142,1024184,1024324,1024114,1024128,1024254,1024212,1024310,1024282,1415832,1024226,1233148,1415820,1319416,1319411,1319406,1319401,1319421,1415838,1024170,1024156,1024198,1233176,1407992,1407956,1408001,1407974,1233106,1407965,1408028,1407983,1408019,1408010,905993,905909,969695,906005,969673,969739,969684,969640,905933,905945,905921,905957,969750,906041,906017,1322632,969662,905981)
      #outliers = c(outliers,969717,1233204,905969,1317767,969706,906029,1317759,969728,1317771,1317763,1411384,969651,1322611,286530,286341,286611,286206,286233,286746,286476,1411393,286773,286260,286503,286368,286584,286152,286800,286665,286098,286287,286449,286719,286125,1411375,286557,286314,286692,286638,286179,286395,286422,1233120,1411402,1126407,1411447,1411420,1411429,1411438,1411411,1126220,1126373,1126424,1126322,1126271,1126254,1126356,1126441,1126339,1126237,1126203,1126305,1126458,1126288,1126186,1322639,1408674,1408638,1408647,1408656,1408620,1408629,1408665,1408692,1408683,1126390,1233260,1030643,1030688,1322618,1408676,1408640,1408649,1408658,1408622,1408631,1408667,1408694,1408685,1030679,911628,1118543,911718,1030634,1030706,911793,911658,1030697,1024268,1233134,911583,1030661,1341664,1030652,1341691,1030670,1341682,1152694,1341646,1341655,1118708,1341700,1341637,1322646,1152813,1341709,1341673,1428679,911673,1428625,1152915,1428643,911778,1428616,1428652,1152711,911733,1118603,1428670,1428634,1428688,1428661,1152932,911748,911643,1324022,1233246,911703,1322625,1152898,1152762,911598,1118663,1152830,911688,1152847,1152728,1024352,1322653,1152779,1152949,1118723,1152796,1152745,1152864,1152881,911613,1118678,911763,1228534,1233190,1024296,1118573,1166339,1228586,1166369,1118648,1166345,1428754,1166357,1228521,1324046,1380511,1118513,1380566,1428774,1380599,1380555,1380588,1428759,1380522,1380533,1380544,1380621,1428769,1233092,1380577,1228573,1380610,1428764,1054633,1118693,1360930,1228599,1349424,1360934,1318556,1118528,1076412,1349396,1349410,1349438,1318571,1360926,1228508,1054777,1118558,1076277,1024240,1318551,1360922,1228482,1349417,1076292,1318566,1118618,1024338,1349431,1318561,1233078,1076397,1126408,1166351,1054765,1228651,1427432,1349403,1076307,1118633,1126221,1324034,1126374,1427423,1126425,1427414,1126323,1126272,1427450,1076442,1427477,1126255,1427459,1228560,1427468,1427405,1153779,1427441,1126357,1126442,1153792,1153675,1126340,1153818,1153727,1153701,1153714,1153766,1153688,1153753,1076352,1126238,1126204,1054753,1118588,1126306,1126459,1126702,1126289,1153805,1361215,1076247,1228612,1126187,1423493,1361203,1423445,1423461,1076337,1361227,1423469,1423453,1324329,1324379,1324369,1076262,1423437,1361197,1324299,1228638,1054705,1126720,1324319,1361209,1076457,1423485,1361221,1324349,1076367,1233162,1228625,1126391,1076427,1126711,1054789,1076382,1324289,1324309,1228547,1076322,1423477,1126747,1166363,1324339,1054609,1228469,1126729,1324010,1324359,1126693,1228495,1054681,1153662,1126684,1054621,1126738,911623,1324015,1126675,911713,1076422,1054801,911788,911653,911578,1076287,1054813,1323986,1076302,1054693,1076407,911668,1296883,1076317,1153740,1054669,911773,1076452,911728,1076362,1054717,1076257,911743,911638,1076347,911698,911593,1076272,1054729,1076467,1127352,911683,1323974,1076377,1127366,1054657,1076437,1127408,1324039,1076392,1127373,1296891,1076332,1127380,1054645,1384133,911608,1127345,1127394,1127359,1127401,1349419,1127387,1384142,1054741,911758,1384106,1349391,1349405,1349433,346197,1384160,1384115,1384124,346269,1384178,1324082,1384169)
      #outliers = c(outliers,346242,1278348,1384151,346233,1349412,1278341,346224,346215,1296867,346260,1349426,346251,346206,1278355,1184419,1278334,1349398,1322633,1278320,1278327,1324027,1184451,1278362,1426513,1303517,405437,1303535,1323998,1184443,1303505,1426501,405608,1296875,1303529,1303523,1303511,1426525,405475,1297312,405418,1184459,1426507,405684,405494,405665,1297322,405627,1426519,1106171,1318542,1297327,405589,1426495,1184427,405722,1106159,1379262,1297317,405646,1106177,1297332,1330992,1322612,1106189,1184475,1296843,1106195,1106165,1252213,1106183,1252173,1252203,1252183,1252133,405779,1252153,1252223,1252193,1252163,1252233,1252143,1426508,1388313,1184467,1323962,1426496,1324003,1426520,1184435,1128474,1314604,1314594,1314599,1314609,1314589,405741,1426502,1289579,1331032,1296851,1426514,1412517,1376953,1426490,784436,1376983,345616,345590,345902,345824,345720,345694,345876,345564,345928,345798,346058,345954,345980,346162,345668,346110,346006,346032,345538,345746,345772,346084,346188,345642,345850,784722,1376943,346136,784670,1388295,1376923,784956,1379298,784878,784618,784462,785060,784774,784696,1322640,784904,784930,785008,784748,785112,784540,784800,785086,784514,784488,784644,784826,1376933,785034,784566,784852,784982,784592,405570,405532,1376973,405456,1289569,1376993,1128464,1324094,1318502,1377003,405551,1376963,1377013,1331052,1303260,1303282,1303304,1303315)
      #noOuts.dat = reg.dat[-outliers,]
      noOuts.dat = reg.dat[rstudent(all.mod)<10,]
      all.noOuts.mod= lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = noOuts.dat)
      outlierTest(all.noOuts.mod) # Bonferonni p-value for most extreme obs
      sampleIndex = sample(nrow(noOuts.dat), size = nrow(noOuts.dat)/2, replace = FALSE)
      sample.dat = noOuts.dat[sampleIndex,]
      sample.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = sample.dat)
      #out of sample
        outsample.dat = noOuts.dat[-sampleIndex,]
        yVect = outsample.dat$npatappAdj
        curMean = mean(yVect)
        curSSTot = sum((yVect-curMean)^2)
        curPred = predict(sample.mod, outsample.dat)
        curSSRes = sum((yVect-curPred)^2)
        curR2= 1-(curSSRes/curSSTot)
      #qqplot
        qqnorm(residuals(sample.mod), ylab="Residuals") # Q-Q plot
        qqline(residuals(all.mod))
    #add square terms, sampled
      sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/2, replace = FALSE)
      sample.dat = reg.dat[sampleIndex,]
      sample.mod = lm(npatappAdj~state_co +I(state_co^2) + stError_co+ I(stError_co^2)+ state_ind+I(state_ind^2) + I(stError_ind^2), data = sample.dat)
      #out of sample
        outsample.dat = reg.dat[-sampleIndex,]
        yVect = outsample.dat$npatappAdj
        curMean = mean(yVect)
        curSSTot = sum((yVect-curMean)^2)
        curPred = predict(sample.mod, outsample.dat)
        curSSRes = sum((yVect-curPred)^2)
        curR2= 1-(curSSRes/curSSTot)
      #diagnostic
        qqnorm(residuals(sample.mod), ylab="Residuals") # Q-Q plot
    #remove zero terms, sampled
      noZero.dat = reg.dat[reg.dat$npatappAdj != 0,]
      sampleIndex = sample(nrow(noZero.dat), size = nrow(noZero.dat)/2, replace = FALSE)
      sample.dat = noZero.dat[sampleIndex,]
      sample.mod = lm(npatappAdj~state_co +I(state_co^2) + stError_co+ I(stError_co^2)+ state_ind+I(state_ind^2) + I(stError_ind^2), data = sample.dat)
      #out of sample
        outsample.dat = noZero.dat[-sampleIndex,]
        yVect = outsample.dat$npatappAdj
        curMean = mean(yVect)
        curSSTot = sum((yVect-curMean)^2)
        curPred = predict(sample.mod, outsample.dat)
        curSSRes = sum((yVect-curPred)^2)
        curR2= 1-(curSSRes/curSSTot)
      #diagnostic
        qqnorm(residuals(sample.mod), ylab="Residuals") # Q-Q plot
    #all adjustments
      allAdj.dat = noOuts.dat[noOuts.dat$npatappAdj != 0,]
      sampleIndex = sample(nrow(allAdj.dat), size = nrow(allAdj.dat)/2, replace = FALSE)
      sample.dat = reg.dat[sampleIndex,]
      sample.mod = lm(npatappAdj~state_co +I(state_co^2) + stError_co+ I(stError_co^2)+ state_ind+I(state_ind^2) + I(stError_ind^2), data = sample.dat)
    #out of sample
      outsample.dat = allAdj.dat[-sampleIndex,]
      yVect = outsample.dat$npatappAdj
      curMean = mean(yVect)
      curSSTot = sum((yVect-curMean)^2)
      curPred = predict(sample.mod, outsample.dat)
      curSSRes = sum((yVect-curPred)^2)
      curR2= 1-(curSSRes/curSSTot)
    #diagnostic
      qqnorm(residuals(sample.mod), ylab="Residuals") # Q-Q plot
    #robust regression
      robust.mod = rlm(npatappAdj~state_co +I(state_co^2) + stError_co+ I(stError_co^2)+ state_ind+I(state_ind^2) + I(stError_ind^2), data = reg.dat, maxit = 60)
    #add industry dummies
      reg.dat$industryName = as.factor(reg.dat$industryName)
      #allInd.mod = lm(npatappAdj~industryName + state_co + stError_co + state_ind + stError_ind, data = reg.dat)
      sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/4, replace = FALSE)
      sample.dat = reg.dat[sampleIndex,]
      sampleInd.mod = lm(npatappAdj~industryName+state_co + stError_co + state_ind + stError_ind, data = sample.dat)
      #out of sample
      outsample.dat = reg.dat[-sampleIndex,]
      yVect = outsample.dat$npatappAdj
      curMean = mean(yVect)
      curSSTot = sum((yVect-curMean)^2)
      curPred = predict(sampleInd.mod, outsample.dat)
      curSSRes = sum((yVect-curPred)^2)
      curR2= 1-(curSSRes/curSSTot)
    #industry dummy interactions
      sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/64, replace = FALSE)
      sample.dat = reg.dat[sampleIndex,]
      sampleInd2.mod = lm(npatappAdj~state_co + stError_co + state_ind + stError_ind, data = sample.dat)
    #random effects (different intercept for each industry (or company))
      #random intercepts
        sampleRE.mod = lmer(npatappAdj~state_co + stError_co +state_ind + stError_ind + (1|industryName), data = sample.dat)
      #random intercepts and slopes
        sampleRE.mod = lmer(npatappAdj~state_co + stError_co +state_ind + stError_ind + (1+state_ind|industryName), data = sample.dat)
      #see here for move info: http://www.bodowinter.com/tutorial/bw_LME_tutorial2.pdf

  #logistic regression
    #all data model
      #set up categories
        #plot(reg.dat$npatappAdj)
        reg.dat$catNumPat = NA
        reg.dat[reg.dat$npatappAdj==0,]$catNumPat= 0
        percentile = quantile(reg.dat[reg.dat$npatappAdj >0,]$npatappAdj, c(.5))
        reg.dat[reg.dat$npatappAdj>0 & reg.dat$npatappAdj < percentile,]$catNumPat= 1
        reg.dat[reg.dat$npatappAdj >= percentile,]$catNumPat= 2
        #plot(reg.dat[reg.dat$npatappAdj >0,]$npatappAdj)
    #using multinom
        test <- multinom(catNumPat ~ state_co + stError_co + state_ind + stError_ind, data = reg.dat)
        exp(coef(test))
        #pvalues
          summary.test = summary(test, Wald = TRUE)
          pchisq(summary.test$Wald.ratios^2, df = 1, low = F)
        #fit
        mod = test
        fitstat(mod)
    #using mlogit (reshape is too expensive)
      #sampleIndex = sample(nrow(reg.dat), size = nrow(reg.dat)/256, replace = FALSE)
      #sample.dat = reg.dat[sampleIndex,]
      #mlogitin.dat = mlogit.data(sample.dat, shape = "wide", choice = "npatappAdj")
      #mlogit()

  #function for getting fit output for multinom
  fitstat <- function(object) { 
    #thanks Ripley, B. D. for telling how to get the LogLik and when is invalid. 
  {if (!is.null(object$call$summ) && !identical(object$call$summ,0)) 
    stop("when 'summ' argument is not zero,can NOT get Loglik") } 
  object.base <- update(object,.~1,trace=FALSE) 
  dev.base <- deviance(object.base) ; L.base <- - dev.base/2 
  dev.full <- deviance(object) ; L.full <- - dev.full/2 
  G2 <- dev.base - dev.full 
  df <- object$edf - object.base$edf 
  LR.test.p <- pchisq(G2,df,lower=F) 
  
  aic <- object$AIC 
  
  n<-dim(object$residuals)[1] 
  
  #get the predict value to cal count R2 
  pre <- predict(object,type="class") 
  y <- eval.parent(object$call$data)[,as.character(object$call$formula[[2]])] 
  if (!identical(length(y),length(pre))) stop("Length not matched.") 
  tab <- table(y,pre) 
  if (!identical(dim(tab)[1],dim(tab)[2])) stop("pred and y have diff nlevels") 
  ad <- max(rowSums(tab))#max of row sum 
  
  #cal R2 
  ML.R2 <- 1-exp(-G2/n) 
  McFadden.R2 <- 1-(L.full/L.base) 
  McFadden.Adj.R2 <- 1-((L.full-mod$edf)/L.base) 
  Cragg.Uhler.R2 <- ML.R2/(1-exp(2*L.base/n)) 
  Count.R2 <- sum(diag(tab))/sum(tab) 
  Count.adj.R2 <- (sum(diag(tab))-ad)/(sum(tab)-ad) 
  
  #get the result 
  res<-list(LR=G2,df=df,LR.test.p =LR.test.p 
            ,aic=aic,ML.R2=ML.R2,Cragg.Uhler.R2=Cragg.Uhler.R2,McFadden.R2 
            =McFadden.R2 ,McFadden.Adj.R2=McFadden.Adj.R2,Count.R2=Count.R2,Count.adj.R2=Count.adj.R2) 
  
  #print the result 
  cat("\n", 
      paste(rep("-",21)), 
      "\n The Fitstats are : \n", 
      sprintf("G2(%d) = %f",df,G2), 
      " ,Prob ",format.pval(LR.test.p), 
      "\n",sprintf("AIC   = %f",aic), 
      sprintf(",ML.R2 = %f \n",ML.R2), 
      paste(rep("-",21)),"\n", 
      sprintf("Cragg.Uhler.R2  = %f \n",Cragg.Uhler.R2), 
      sprintf("McFadden.R2     = %f \n",McFadden.R2), 
      sprintf("McFadden.Adj.R2 = %f \n",McFadden.Adj.R2), 
      sprintf("Count.R2        = %f \n",Count.R2), 
      sprintf("Count.adj.R2    = %f \n",Count.adj.R2), 
      "\n Note:The maxinum of ML R2 is less than 1 \n", 
      paste(rep("-",21)),"\n") 
  invisible(res) 
  } 


